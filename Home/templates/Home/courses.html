{% extends 'Home/base.html' %}
{% load static %}

{% block title %}Courses | BlackCodeLabs{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'assets/css/courses.css' %}">
{% endblock %}

{% block content %}
    <!-- Courses Hero -->
    <section class="courses-hero">
        <div class="container">
            <h1>Master the Future of Technology</h1>
            <p>Learn from industry experts with hands-on projects, live sessions, and career support. Start your journey today with our comprehensive coding courses.</p>
            <div class="hero-stats">
                <div class="hero-stat">
                    <div class="hero-stat-number">50+</div>
                    <div class="hero-stat-label">Courses Available</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-number">10K+</div>
                    <div class="hero-stat-label">Students Enrolled</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-number">98%</div>
                    <div class="hero-stat-label">Satisfaction Rate</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-number">500+</div>
                    <div class="hero-stat-label">Expert Instructors</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Courses Section -->
    <section class="courses-section">
        <div class="container">
            <div class="section-title">
                <h2>Explore Our Courses</h2>
                <p>Choose from a wide range of cutting-edge technology courses designed for all skill levels</p>
            </div>
            
            <div class="courses-filter">
                <button class="filter-btn active" data-filter="all">All Courses</button>
                <button class="filter-btn" data-filter="beginner">Beginner</button>
                <button class="filter-btn" data-filter="intermediate">Intermediate</button>
                <button class="filter-btn" data-filter="advanced">Advanced</button>
                <button class="filter-btn" data-filter="python">Python</button>
                <button class="filter-btn" data-filter="javascript">JavaScript</button>
                <button class="filter-btn" data-filter="iot">IoT</button>
                <button class="filter-btn" data-filter="ai">AI & ML</button>
                <button class="filter-btn" data-filter="scratch">Scratch for Kids</button>
            </div>
            
            <div class="courses-grid" id="courses-container">
                <!-- Course cards will be populated by JavaScript -->
            </div>
        </div>
    </section>

    <!-- Learning Platform -->
    <section class="learning-platform">
        <div class="container">
            <div class="section-title">
                <h2>Why Learn With BlackCodeLabs?</h2>
                <p>Our platform is designed to give you the best learning experience with cutting-edge features</p>
            </div>
            
            <div class="platform-features">
                <div class="platform-feature">
                    <i class="fas fa-laptop-code"></i>
                    <h3>Live Online Classes</h3>
                    <p>Interactive sessions with industry experts and real-time Q&A opportunities.</p>
                </div>
                
                <div class="platform-feature">
                    <i class="fas fa-project-diagram"></i>
                    <h3>Hands-on Projects</h3>
                    <p>Build real-world applications and add them to your professional portfolio.</p>
                </div>
                
                <div class="platform-feature">
                    <i class="fas fa-certificate"></i>
                    <h3>Industry Certifications</h3>
                    <p>Earn recognized certificates that boost your resume and career prospects.</p>
                </div>
                
                <div class="platform-feature">
                    <i class="fas fa-user-tie"></i>
                    <h3>Career Support</h3>
                    <p>Get career guidance, interview preparation, and job placement assistance.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Course Details Modal -->
    <div class="course-modal" id="courseModal">
        <div class="course-modal-content">
            <div class="course-modal-header">
                <button class="course-modal-close" id="closeCourseModal">&times;</button>
                <h1 class="course-modal-title" id="modalCourseTitle">Python Masterclass</h1>
                <div class="course-modal-meta" id="modalCourseMeta">
                    <span><i class="fas fa-clock"></i> <span id="modalDuration">12 Weeks</span></span>
                    <span><i class="fas fa-signal"></i> <span id="modalLevel">Beginner to Advanced</span></span>
                    <span><i class="fas fa-users"></i> <span id="modalStudents">2450 students</span></span>
                    <span><i class="fas fa-star"></i> <span id="modalRating">4.9 (1200 reviews)</span></span>
                </div>
            </div>
            
            <div class="course-modal-image">
                <i class="fab fa-python" id="modalCourseIcon"></i>
            </div>
            
            <div class="course-modal-body">
                <div class="course-modal-intro" id="modalCourseIntro">
                    Master Python programming from basics to advanced concepts with hands-on projects.
                </div>
                
                <div class="course-details-grid" id="modalCourseDetails">
                    <!-- Filled by JavaScript -->
                </div>
                
                <div class="curriculum-section" id="curriculumSection">
                    <h3>Course Curriculum</h3>
                    <!-- Filled by JavaScript -->
                </div>
                
                <div class="instructor-section">
                    <h3>About the Instructor</h3>
                    <div class="instructor-info">
                        <div class="instructor-avatar">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <div class="instructor-details">
                            <h4 id="modalInstructorName">Dr. Alex Johnson</h4>
                            <p id="modalInstructorBio">Senior AI Engineer with 10+ years of experience in Python development and machine learning. Former lead developer at TechGiant Inc.</p>
                        </div>
                    </div>
                </div>
                
                <div class="enrollment-section">
                    <div class="enrollment-price" id="modalCoursePrice">$199 <span>$299</span></div>
                    <div class="enrollment-details" id="modalEnrollmentDetails">
                        Includes lifetime access, certificate of completion, and all future updates
                    </div>
                    <button class="enrollment-button" id="enrollButton">Enroll Now</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Registration Modal -->
    <div class="registration-modal" id="registrationModal">
        <div class="registration-modal-content">
            <div class="registration-modal-header">
                <button class="registration-modal-close" id="closeRegistrationModal">&times;</button>
                <h1 class="registration-modal-title">Enroll in <span id="registrationCourseTitle">Course</span></h1>
                <div class="registration-modal-subtitle" id="registrationCourseSubtitle">Complete the form below to register for this course</div>
            </div>
            
            <div class="registration-modal-body">
                <form class="registration-form" id="registrationForm" method="post" action="{% url 'courses' %}">
                    {% csrf_token %}
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName">First Name</label>
                            <input type="text" id="firstName" name="first_name" required>
                        </div>
                        <div class="form-group">
                            <label for="lastName">Last Name</label>
                            <input type="text" id="lastName" name="last_name" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="phone">Phone Number</label>
                        <input type="tel" id="phone" name="phone" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="country">Country</label>
                        <select id="country" name="country" required>
                            <option value="">Select Country</option>
                            <option value="US">United States</option>
                            <option value="UK">United Kingdom</option>
                            <option value="CA">Canada</option>
                            <option value="AU">Australia</option>
                            <!-- More countries... -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="experience">Programming Experience</label>
                        <select id="experience" name="experience" required>
                            <option value="">Select Experience Level</option>
                            <option value="beginner">Beginner (0-1 years)</option>
                            <option value="intermediate">Intermediate (1-3 years)</option>
                            <option value="advanced">Advanced (3+ years)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="goals">What are your learning goals?</label>
                        <textarea id="goals" name="goals" placeholder="Tell us what you hope to achieve with this course..."></textarea>
                    </div>
                    
                    <div class="payment-summary">
                        <h4>Order Summary</h4>
                        <div class="payment-item">
                            <span>Course Fee:</span>
                            <span id="courseFee">$199.00</span>
                        </div>
                        <div class="payment-item">
                            <span>Platform Fee:</span>
                            <span>$10.00</span>
                        </div>
                        <div class="payment-item">
                            <span>Tax:</span>
                            <span id="taxAmount">$20.89</span>
                        </div>
                        <div class="payment-total">
                            <span>Total:</span>
                            <span id="totalAmount">$229.89</span>
                        </div>
                    </div>
                    
                    <button type="submit" class="submit-registration">Complete Enrollment & Pay</button>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Get courses data from Django context
    const courses = JSON.parse('{{ courses_json|escapejs }}');
    
    // Get CSRF token for AJAX requests
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // DOM Elements
    const coursesContainer = document.getElementById('courses-container');
    const courseModal = document.getElementById('courseModal');
    const registrationModal = document.getElementById('registrationModal');
    const closeCourseModal = document.getElementById('closeCourseModal');
    const closeRegistrationModal = document.getElementById('closeRegistrationModal');
    const filterButtons = document.querySelectorAll('.filter-btn');
    const enrollButton = document.getElementById('enrollButton');
    const registrationForm = document.getElementById('registrationForm');
    const courseFeeElement = document.getElementById('courseFee');
    const taxAmountElement = document.getElementById('taxAmount');
    const totalAmountElement = document.getElementById('totalAmount');
    const registrationCourseTitle = document.getElementById('registrationCourseTitle');
    const registrationCourseSubtitle = document.getElementById('registrationCourseSubtitle');

    // Current selected course
    let currentCourse = null;

    // Initialize courses
    function initCourses() {
        renderCourses(courses);
        setupEventListeners();
    }

    // Render courses to the DOM
    function renderCourses(coursesToRender) {
        coursesContainer.innerHTML = '';
        
        coursesToRender.forEach(course => {
            const courseCard = document.createElement('div');
            courseCard.className = `course-card ${course.category} ${course.level}`;
            courseCard.setAttribute('data-id', course.id);
            
            let badgeHTML = '';
            if (course.badge) {
                let badgeText = '';
                if (course.badge === 'popular') badgeText = 'Most Popular';
                else if (course.badge === 'new') badgeText = 'New';
                else if (course.badge === 'advanced') badgeText = 'Advanced';
                else if (course.badge === 'kids') badgeText = 'For Kids';
                
                badgeHTML = `<div class="course-badge ${course.badge}">${badgeText}</div>`;
            }
            
            courseCard.innerHTML = `
                ${badgeHTML}
                <div class="course-image" style="background: linear-gradient(45deg, ${course.color}, var(--space-blue))">
                    <i class="${course.icon}"></i>
                </div>
                <div class="course-content">
                    <div class="course-category">${course.category.toUpperCase()}</div>
                    <h3 class="course-title">${course.title}</h3>
                    <p class="course-description">${course.description}</p>
                    <div class="course-meta">
                        <div class="course-meta-item">
                            <i class="fas fa-clock"></i>
                            <span>${course.duration}</span>
                        </div>
                        <div class="course-meta-item">
                            <i class="fas fa-book"></i>
                            <span>${course.lessons}</span>
                        </div>
                        <div class="course-meta-item">
                            <i class="fas fa-signal"></i>
                            <span>${course.level}</span>
                        </div>
                    </div>
                    <div class="course-footer">
                        <div class="course-price">
                            $${course.price}
                            ${course.originalPrice ? `<span>$${course.originalPrice}</span>` : ''}
                        </div>
                        <button class="course-button view-course" data-id="${course.id}">View Course</button>
                    </div>
                </div>
            `;
            
            coursesContainer.appendChild(courseCard);
        });
        
        // Add event listeners to view buttons
        document.querySelectorAll('.view-course').forEach(button => {
            button.addEventListener('click', (e) => {
                const courseId = parseInt(e.target.getAttribute('data-id'));
                openCourseModal(courseId);
            });
        });
    }

    // Open course modal
    function openCourseModal(courseId) {
        currentCourse = courses.find(course => course.id === courseId);
        
        if (currentCourse) {
            // Update modal content
            document.getElementById('modalCourseTitle').textContent = currentCourse.title;
            document.getElementById('modalCourseIcon').className = currentCourse.icon;
            document.getElementById('modalCourseIntro').textContent = currentCourse.description;
            document.getElementById('modalDuration').textContent = currentCourse.duration;
            document.getElementById('modalLevel').textContent = currentCourse.level.charAt(0).toUpperCase() + currentCourse.level.slice(1);
            document.getElementById('modalStudents').textContent = `${currentCourse.students} students`;
            document.getElementById('modalRating').textContent = `${currentCourse.rating} (${Math.floor(currentCourse.students / 2)} reviews)`;
            document.getElementById('modalInstructorName').textContent = currentCourse.instructor;
            document.getElementById('modalCoursePrice').innerHTML = `$${currentCourse.price} ${currentCourse.originalPrice ? `<span>$${currentCourse.originalPrice}</span>` : ''}`;
            
            // Update course details grid
            const detailsGrid = document.getElementById('modalCourseDetails');
            detailsGrid.innerHTML = '';
            
            for (const [key, value] of Object.entries(currentCourse.details)) {
                detailsGrid.innerHTML += `
                    <div class="detail-item">
                        <i class="fas fa-info-circle"></i>
                        <div class="detail-label">${key}</div>
                        <div class="detail-value">${value}</div>
                    </div>
                `;
            }
            
            // Add special features for Scratch course
            if (currentCourse.category === 'scratch') {
                detailsGrid.innerHTML += `
                    <div class="detail-item">
                        <i class="fas fa-child"></i>
                        <div class="detail-label">Kid-Friendly</div>
                        <div class="detail-value">Visual Coding</div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-trophy"></i>
                        <div class="detail-label">Certificates</div>
                        <div class="detail-value">Digital Badges</div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-users"></i>
                        <div class="detail-label">Class Size</div>
                        <div class="detail-value">Max 8 Students</div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-comments"></i>
                        <div class="detail-label">Parent Updates</div>
                        <div class="detail-value">Weekly Reports</div>
                    </div>
                `;
            }
            
            // Update curriculum section
            const curriculumSection = document.getElementById('curriculumSection');
            if (currentCourse.curriculum && currentCourse.curriculum.length > 0) {
                let curriculumHTML = '<h3>Course Curriculum</h3>';
                
                currentCourse.curriculum.forEach((module, index) => {
                    const isActive = index === 0 ? 'active' : '';
                    const lessonsHTML = module.lessons ? module.lessons.map(lesson => 
                        `<li><i class="fas fa-play-circle"></i> ${lesson}</li>`
                    ).join('') : '';
                    
                    curriculumHTML += `
                        <div class="curriculum-item ${isActive}">
                            <div class="curriculum-header">
                                <h4>${module.title || 'Module ' + (index + 1)}</h4>
                                <i class="fas fa-chevron-down curriculum-icon"></i>
                            </div>
                            <div class="curriculum-content">
                                <ul class="curriculum-lessons">
                                    ${lessonsHTML}
                                </ul>
                            </div>
                        </div>
                    `;
                });
                
                curriculumSection.innerHTML = curriculumHTML;
                
                // Re-initialize curriculum accordion
                setupCurriculumAccordion();
            } else {
                curriculumSection.innerHTML = '<h3>Course Curriculum</h3><p>Curriculum details coming soon!</p>';
            }
            
            // Set modal image background
            document.querySelector('.course-modal-image').style.background = `linear-gradient(45deg, ${currentCourse.color}, var(--space-blue))`;
            
            // Show modal
            courseModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    }

    // Open registration modal
    function openRegistrationModal() {
        if (currentCourse) {
            registrationCourseTitle.textContent = currentCourse.title;
            registrationCourseSubtitle.textContent = `Complete the form below to register for ${currentCourse.title}`;
            
            // Calculate fees
            const platformFee = 10;
            const taxRate = 0.1;
            const taxAmount = (currentCourse.price + platformFee) * taxRate;
            const totalAmount = currentCourse.price + platformFee + taxAmount;
            
            courseFeeElement.textContent = `$${currentCourse.price.toFixed(2)}`;
            taxAmountElement.textContent = `$${taxAmount.toFixed(2)}`;
            totalAmountElement.textContent = `$${totalAmount.toFixed(2)}`;
            
            // Set hidden course_id field
            const courseIdInput = document.querySelector('input[name="course_id"]');
            if (courseIdInput) {
                courseIdInput.value = currentCourse.id;
            } else {
                // Create hidden input if it doesn't exist
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'course_id';
                hiddenInput.value = currentCourse.id;
                registrationForm.appendChild(hiddenInput);
            }
            
            registrationModal.classList.add('active');
        }
    }

    // Close modals
    function closeModals() {
        courseModal.classList.remove('active');
        registrationModal.classList.remove('active');
        document.body.style.overflow = 'auto';
    }

    // Filter courses
    function filterCourses(filter) {
        filterButtons.forEach(btn => {
            if (btn.getAttribute('data-filter') === filter) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        
        let filteredCourses = courses;
        
        if (filter !== 'all') {
            filteredCourses = courses.filter(course => 
                course.category === filter || 
                course.level === filter
            );
        }
        
        renderCourses(filteredCourses);
    }

    // Setup curriculum accordion
    function setupCurriculumAccordion() {
        document.querySelectorAll('.curriculum-header').forEach(header => {
            header.addEventListener('click', () => {
                const item = header.parentElement;
                item.classList.toggle('active');
            });
        });
    }

    // Handle form submission (AJAX version)
    async function handleRegistrationSubmit(e) {
        e.preventDefault();
        
        // Get form data
        const formData = new FormData(registrationForm);
        const formObject = {};
        formData.forEach((value, key) => {
            formObject[key] = value;
        });
        
        // Add course_id if not in form
        if (!formObject.course_id && currentCourse) {
            formObject.course_id = currentCourse.id;
        }
        
        try {
            // Send AJAX request
            const response = await fetch('{% url "course_enroll_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(formObject)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(result.message, 'success');
                registrationForm.reset();
                closeModals();
                
                // Reload page to update student count
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showToast(result.error || 'Registration failed. Please try again.', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Network error. Please try again.', 'error');
        }
    }

    // Show toast notification
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? 'var(--accent)' : '#ff6b6b'};
            color: ${type === 'success' ? 'var(--dark)' : 'white'};
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 9999;
            transform: translateX(100%);
            transition: transform 0.3s;
            font-weight: 600;
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.transform = 'translateX(0)';
        }, 100);
        
        setTimeout(() => {
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }

    // Setup event listeners
    function setupEventListeners() {
        // Filter buttons
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                const filter = button.getAttribute('data-filter');
                filterCourses(filter);
            });
        });
        
        // Close modals
        closeCourseModal.addEventListener('click', closeModals);
        closeRegistrationModal.addEventListener('click', closeModals);
        
        // Close modals when clicking outside
        courseModal.addEventListener('click', (e) => {
            if (e.target === courseModal) {
                closeModals();
            }
        });
        
        registrationModal.addEventListener('click', (e) => {
            if (e.target === registrationModal) {
                closeModals();
            }
        });
        
        // Enroll button
        enrollButton.addEventListener('click', openRegistrationModal);
        
        // Form submission - use AJAX
        registrationForm.addEventListener('submit', handleRegistrationSubmit);
        
        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModals();
            }
        });
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', initCourses);
</script>
{% endblock %}