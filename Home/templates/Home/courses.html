{% extends 'Home/base.html' %}
{% load static %}

{% block title %}Courses | BlackCodeLabs{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'assets/css/courses.css' %}">
<style>
    /* Debug info */
    .debug-info {
        display: none;
        background: #f0f0f0;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        font-family: monospace;
        font-size: 12px;
    }
</style>
{% endblock %}

{% block content %}
    <!-- Courses Hero -->
    <section class="courses-hero">
        <div class="container">
            <h1>Master the Future of Technology</h1>
            <p>Learn from industry experts with hands-on projects, live sessions, and career support. Start your journey today with our comprehensive coding courses.</p>
            <div class="hero-stats">
                <div class="hero-stat">
                    <div class="hero-stat-number">{{ stats.total_courses|default:"50" }}+</div>
                    <div class="hero-stat-label">Courses Available</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-number">{{ stats.total_students|default:"10K" }}+</div>
                    <div class="hero-stat-label">Students Enrolled</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-number">{{ stats.satisfaction_rate|default:"98" }}%</div>
                    <div class="hero-stat-label">Satisfaction Rate</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-number">{{ stats.total_instructors|default:"500" }}+</div>
                    <div class="hero-stat-label">Expert Instructors</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Courses Section -->
    <section class="courses-section">
        <div class="container">
            <div class="section-title">
                <h2>Explore Our Courses</h2>
                <p>Choose from a wide range of cutting-edge technology courses designed for all skill levels</p>
            </div>
            
            <div class="courses-filter">
                <button class="filter-btn active" data-filter="all">All Courses</button>
                <button class="filter-btn" data-filter="beginner">Beginner</button>
                <button class="filter-btn" data-filter="intermediate">Intermediate</button>
                <button class="filter-btn" data-filter="advanced">Advanced</button>
                {% for category in categories %}
                <button class="filter-btn" data-filter="{{ category.0 }}">{{ category.1 }}</button>
                {% endfor %}
            </div>
            
            <!-- Debug info (visible only in development) -->
            <div class="debug-info" id="debugInfo">
                Loading courses data...
            </div>
            
            <div class="courses-grid" id="courses-container">
                <!-- Static fallback if JavaScript fails -->
                {% for course in courses %}
                <div class="course-card" data-id="{{ course.id }}" data-category="{{ course.category }}" data-level="{{ course.level }}">
                    {% if course.badge %}
                    <div class="course-badge {{ course.badge }}">
                        {% if course.badge == 'popular' %}Most Popular
                        {% elif course.badge == 'new' %}New
                        {% elif course.badge == 'advanced' %}Advanced
                        {% elif course.badge == 'kids' %}For Kids
                        {% endif %}
                    </div>
                    {% endif %}
                    <div class="course-image" style="background: linear-gradient(45deg, {{ course.color }}, var(--space-blue))">
                        <i class="{{ course.icon_class }}"></i>
                    </div>
                    <div class="course-content">
                        <div class="course-category">{{ course.get_category_display|upper }}</div>
                        <h3 class="course-title">{{ course.title }}</h3>
                        <p class="course-description">{{ course.short_description }}</p>
                        <div class="course-meta">
                            <div class="course-meta-item">
                                <i class="fas fa-clock"></i>
                                <span>{{ course.duration }}</span>
                            </div>
                            <div class="course-meta-item">
                                <i class="fas fa-book"></i>
                                <span>{{ course.lessons }}</span>
                            </div>
                            <div class="course-meta-item">
                                <i class="fas fa-signal"></i>
                                <span>{{ course.get_level_display }}</span>
                            </div>
                        </div>
                        <div class="course-footer">
                            <div class="course-price">
                                ${{ course.price }}
                                {% if course.original_price %}
                                <span>${{ course.original_price }}</span>
                                {% endif %}
                            </div>
                            <button class="course-button view-course" data-id="{{ course.id }}">View Course</button>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="no-courses">
                    <p>No courses available at the moment. Please check back soon!</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>

    <!-- Learning Platform -->
    <section class="learning-platform">
        <div class="container">
            <div class="section-title">
                <h2>Why Learn With BlackCodeLabs?</h2>
                <p>Our platform is designed to give you the best learning experience with cutting-edge features</p>
            </div>
            
            <div class="platform-features">
                <div class="platform-feature">
                    <i class="fas fa-laptop-code"></i>
                    <h3>Live Online Classes</h3>
                    <p>Interactive sessions with industry experts and real-time Q&A opportunities.</p>
                </div>
                
                <div class="platform-feature">
                    <i class="fas fa-project-diagram"></i>
                    <h3>Hands-on Projects</h3>
                    <p>Build real-world applications and add them to your professional portfolio.</p>
                </div>
                
                <div class="platform-feature">
                    <i class="fas fa-certificate"></i>
                    <h3>Industry Certifications</h3>
                    <p>Earn recognized certificates that boost your resume and career prospects.</p>
                </div>
                
                <div class="platform-feature">
                    <i class="fas fa-user-tie"></i>
                    <h3>Career Support</h3>
                    <p>Get career guidance, interview preparation, and job placement assistance.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Course Details Modal -->
    <div class="course-modal" id="courseModal">
        <div class="course-modal-content">
            <div class="course-modal-header">
                <button class="course-modal-close" id="closeCourseModal">&times;</button>
                <h1 class="course-modal-title" id="modalCourseTitle">Loading...</h1>
                <div class="course-modal-meta" id="modalCourseMeta">
                    <span><i class="fas fa-clock"></i> <span id="modalDuration">-</span></span>
                    <span><i class="fas fa-signal"></i> <span id="modalLevel">-</span></span>
                    <span><i class="fas fa-users"></i> <span id="modalStudents">- students</span></span>
                    <span><i class="fas fa-star"></i> <span id="modalRating">- (- reviews)</span></span>
                </div>
            </div>
            
            <div class="course-modal-image">
                <i class="fas fa-book" id="modalCourseIcon"></i>
            </div>
            
            <div class="course-modal-body">
                <div class="course-modal-intro" id="modalCourseIntro">
                    Loading course details...
                </div>
                
                <div class="course-details-grid" id="modalCourseDetails">
                    <!-- Filled by JavaScript -->
                </div>
                
                <div class="curriculum-section" id="curriculumSection">
                    <h3>Course Curriculum</h3>
                    <p>Loading curriculum...</p>
                </div>
                
                <div class="instructor-section">
                    <h3>About the Instructor</h3>
                    <div class="instructor-info">
                        <div class="instructor-avatar">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <div class="instructor-details">
                            <h4 id="modalInstructorName">Loading...</h4>
                            <p id="modalInstructorBio">Loading instructor information...</p>
                        </div>
                    </div>
                </div>
                
                <div class="enrollment-section">
                    <div class="enrollment-price" id="modalCoursePrice">$0 <span></span></div>
                    <div class="enrollment-details" id="modalEnrollmentDetails">
                        Includes lifetime access, certificate of completion, and all future updates
                    </div>
                    <button class="enrollment-button" id="enrollButton">Enroll Now</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Registration Modal -->
    <div class="registration-modal" id="registrationModal">
        <div class="registration-modal-content">
            <div class="registration-modal-header">
                <button type="button" class="registration-modal-close" id="closeRegistrationModal">&times;</button>
                <h1 class="registration-modal-title">Enroll in <span id="registrationCourseTitle">Course</span></h1>
                <div class="registration-modal-subtitle" id="registrationCourseSubtitle">Complete the form below to register for this course</div>
            </div>
            
            <div class="registration-modal-body">
                <form class="registration-form" id="registrationForm">
                    {% csrf_token %}
                    <input type="hidden" name="course_id" id="hiddenCourseId" value="">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName">First Name *</label>
                            <input type="text" id="firstName" name="first_name" required>
                            <div class="error-message" id="firstNameError"></div>
                        </div>
                        <div class="form-group">
                            <label for="lastName">Last Name *</label>
                            <input type="text" id="lastName" name="last_name" required>
                            <div class="error-message" id="lastNameError"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email Address *</label>
                        <input type="email" id="email" name="email" required>
                        <div class="error-message" id="emailError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="phone">Phone Number *</label>
                        <input type="tel" id="phone" name="phone" required>
                        <div class="error-message" id="phoneError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="country">Country *</label>
                        <select id="country" name="country" required>
                            <option value="">Select Country</option>
                            <option value="US">United States</option>
                            <option value="CA">Canada</option>
                            <option value="GB">United Kingdom</option>
                            <option value="AU">Australia</option>
                            <option value="IN">India</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                            <option value="JP">Japan</option>
                            <option value="SG">Singapore</option>
                            <option value="AE">United Arab Emirates</option>
                            <!-- African Countries -->
                            <option value="ZA">South Africa</option>
                            <option value="NG">Nigeria</option>
                            <option value="KE">Kenya</option>
                            <option value="GH">Ghana</option>
                            <option value="ET">Ethiopia</option>
                            <option value="EG">Egypt</option>
                            <option value="TZ">Tanzania</option>
                            <option value="UG">Uganda</option>
                            <option value="DZ">Algeria</option>
                            <option value="SD">Sudan</option>
                            <option value="MA">Morocco</option>
                            <option value="AO">Angola</option>
                            <option value="MZ">Mozambique</option>
                            <option value="CI">CÃ´te d'Ivoire</option>
                            <option value="MG">Madagascar</option>
                            <option value="CM">Cameroon</option>
                        </select>
                        <div class="error-message" id="countryError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="experience">Programming Experience *</label>
                        <select id="experience" name="experience_level" required>
                            <option value="">Select Experience Level</option>
                            <option value="beginner">Beginner (0-1 years)</option>
                            <option value="intermediate">Intermediate (1-3 years)</option>
                            <option value="advanced">Advanced (3+ years)</option>
                        </select>
                        <div class="error-message" id="experienceError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="goals">What are your learning goals? (Optional)</label>
                        <textarea id="goals" name="learning_goals" placeholder="Tell us what you hope to achieve with this course..."></textarea>
                    </div>
                    
                    <div class="payment-summary">
                        <h4>Order Summary</h4>
                        <div class="payment-item">
                            <span>Course Fee:</span>
                            <span id="courseFee">$0.00</span>
                        </div>
                        <div class="payment-item">
                            <span>Platform Fee:</span>
                            <span>$10.00</span>
                        </div>
                        <div class="payment-item">
                            <span>Tax:</span>
                            <span id="taxAmount">$0.00</span>
                        </div>
                        <div class="payment-total">
                            <span>Total:</span>
                            <span id="totalAmount">$0.00</span>
                        </div>
                    </div>
                    
                    <button type="submit" class="submit-registration">Complete Enrollment & Pay</button>
                    <div class="form-status" id="formStatus"></div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Debug logging
    console.log('Courses page JavaScript loaded');
    
    // Global courses array with safe defaults
    let courses = [];
    
    try {
        // Get the JSON string from Django context
        const coursesJson = '{{ courses_json|escapejs }}';
        
        if (coursesJson && coursesJson.trim() && coursesJson !== '[]') {
            try {
                // Try to parse the JSON
                courses = JSON.parse(coursesJson);
                
                // Validate and clean each course
                courses = courses.map(course => {
                    // Ensure all required fields exist
                    return {
                        id: course.id || 0,
                        title: course.title || 'Untitled Course',
                        category: course.category || 'web',
                        level: course.level || 'beginner',
                        badge: course.badge || '',
                        icon: course.icon || 'fas fa-book',
                        description: course.description || 'Course description',
                        duration: course.duration || '12 Weeks',
                        lessons: course.lessons || '0',
                        students: parseInt(course.students) || 0,
                        rating: parseFloat(course.rating) || 0,
                        instructor: course.instructor || 'Instructor',
                        price: parseFloat(course.price) || 0,
                        originalPrice: course.originalPrice ? parseFloat(course.originalPrice) : null,
                        color: course.color || '#3776AB',
                        details: course.details || {},
                        curriculum: course.curriculum || [],
                    };
                });
                
                console.log(`Successfully loaded ${courses.length} courses`);
                
            } catch (parseError) {
                console.error('Error parsing courses JSON:', parseError);
                // Fallback to static HTML extraction
                courses = extractCoursesFromHTML();
            }
        } else {
            console.warn('No courses data in context, using static HTML');
            courses = extractCoursesFromHTML();
        }
    } catch (error) {
        console.error('Fatal error loading courses:', error);
        courses = extractCoursesFromHTML();
    }
    
    console.log(`Total courses loaded: ${courses.length}`);
    
    // Fallback function to extract courses from existing HTML
    function extractCoursesFromHTML() {
        console.log('Extracting courses from HTML...');
        const courseCards = document.querySelectorAll('.course-card[data-id]');
        const extractedCourses = [];
        
        courseCards.forEach(card => {
            try {
                const id = parseInt(card.getAttribute('data-id')) || 0;
                const title = card.querySelector('.course-title')?.textContent?.trim() || 'Course Title';
                const description = card.querySelector('.course-description')?.textContent?.trim() || 'Course description';
                const category = card.getAttribute('data-category') || 'web';
                const level = card.getAttribute('data-level') || 'beginner';
                
                // Extract price
                const priceText = card.querySelector('.course-price')?.textContent || '$0';
                const priceMatch = priceText.match(/\$(\d+(\.\d+)?)/);
                const price = priceMatch ? parseFloat(priceMatch[1]) : 0;
                
                // Check for original price
                const originalPriceSpan = card.querySelector('.course-price span');
                const originalPrice = originalPriceSpan ? 
                    parseFloat(originalPriceSpan.textContent.replace('$', '')) : null;
                
                // Extract badge
                const badgeElement = card.querySelector('.course-badge');
                let badge = '';
                if (badgeElement) {
                    const badgeClass = badgeElement.className;
                    if (badgeClass.includes('popular')) badge = 'popular';
                    else if (badgeClass.includes('new')) badge = 'new';
                    else if (badgeClass.includes('advanced')) badge = 'advanced';
                    else if (badgeClass.includes('kids')) badge = 'kids';
                }
                
                // Extract icon
                const iconElement = card.querySelector('.course-image i');
                const icon = iconElement ? iconElement.className : getIconForCategory(category);
                
                // Extract color
                const imageElement = card.querySelector('.course-image');
                const style = imageElement ? imageElement.getAttribute('style') : '';
                const colorMatch = style.match(/linear-gradient\(45deg, (#[0-9A-Fa-f]+)/);
                const color = colorMatch ? colorMatch[1] : getColorForCategory(category);
                
                extractedCourses.push({
                    id: id,
                    title: title,
                    description: description,
                    category: category,
                    level: level,
                    badge: badge,
                    icon: icon,
                    duration: card.querySelector('.course-meta-item:nth-child(1) span')?.textContent || '12 Weeks',
                    lessons: card.querySelector('.course-meta-item:nth-child(2) span')?.textContent || '48 Lessons',
                    students: '1000',
                    rating: '4.5',
                    instructor: 'Expert Instructor',
                    price: price,
                    originalPrice: originalPrice,
                    color: color,
                    details: {},
                    curriculum: []
                });
            } catch (e) {
                console.error('Error extracting course from HTML:', e);
            }
        });
        
        console.log(`Extracted ${extractedCourses.length} courses from HTML`);
        return extractedCourses;
    }
    
    // Helper functions
    function getIconForCategory(category) {
        const icons = {
            'python': 'fab fa-python',
            'javascript': 'fab fa-js-square',
            'iot': 'fas fa-microchip',
            'ai': 'fas fa-robot',
            'scratch': 'fas fa-gamepad',
            'web': 'fas fa-laptop-code',
            'mobile': 'fas fa-mobile-alt',
            'data': 'fas fa-chart-line',
            'security': 'fas fa-shield-alt',
        };
        return icons[category] || 'fas fa-book';
    }
    
    function getColorForCategory(category) {
        const colors = {
            'python': '#3776AB',
            'javascript': '#F7DF1E',
            'iot': '#00979C',
            'ai': '#FF6B6B',
            'scratch': '#FF8C42',
            'web': '#4B8BBE',
            'mobile': '#68A063',
            'data': '#2E8B57',
            'security': '#C51A4A',
        };
        return colors[category] || '#3776AB';
    }
    
    // Update debug info
    const debugInfo = document.getElementById('debugInfo');
    if (debugInfo) {
        debugInfo.textContent = `Loaded ${courses.length} courses`;
        debugInfo.style.display = 'block';
    }
    
    // Rest of your JavaScript remains the same...
    // [Keep all the rest of your JavaScript code from line 245 onward]
</script>
{% endblock %}